---
# roles/waf/tasks/main.yml
# Apache Reverse Proxy + ModSecurity + OWASP CRS
# 목표:
#  - 재배포 시 중복 include / RuleID 중복 방지
#  - 운영(DetectionOnly) / 발표(On + 403 보장) 둘 다 지원
#  - audit 로그는 옵션(환경별 이슈) / 기본은 error_log로 검증
#  - offline(test)에서도 플레이북이 끝까지 돌도록 waf_offline 지원

# ------------------------------------------------------------
# 0) Variables (allow override from inventory/group_vars)
# ------------------------------------------------------------
- name: Set variables (defaults, but keep overrides)
  set_fact:
    waf_backend: "{{ waf_backend | default('http://10.2.2.101/') }}"
    waf_servername: "{{ waf_servername | default('waf.local') }}"
    waf_cert: "{{ waf_cert | default('/etc/pki/tls/certs/waf.crt') }}"
    waf_key: "{{ waf_key | default('/etc/pki/tls/private/waf.key') }}"
    waf_rule_engine: "{{ waf_rule_engine | default('DetectionOnly') }}"   # DetectionOnly / On
    waf_demo_block_enable: "{{ waf_demo_block_enable | default(false) }}" # 발표용 403 보장 룰
    waf_audit_enable: "{{ waf_audit_enable | default(false) }}"           # audit 옵션
    waf_audit_log: "{{ waf_audit_log | default('/var/log/httpd/modsec_audit.log') }}"
    crs_dir: "{{ crs_dir | default('/etc/httpd/modsecurity.d/owasp-crs') }}"
    crs_rules_enabled: "{{ crs_rules_enabled | default('/etc/httpd/modsecurity.d/owasp-crs/rules-enabled') }}"
    waf_offline: "{{ waf_offline | default(false) }}"

# ------------------------------------------------------------
# 1) Packages / Services (offline면 스킵)
# ------------------------------------------------------------
- block:
    - name: Install required packages
      dnf:
        name:
          - httpd
          - mod_ssl
          - mod_security
          - git
          - firewalld
        state: present

    - name: Enable and start firewalld
      systemd:
        name: firewalld
        enabled: true
        state: started
  when:
    - not ansible_check_mode
    - not (waf_offline | bool)

- name: Open 80/443 on firewalld (public) (best effort)
  command: firewall-cmd --permanent --add-service={{ item }}
  loop: [http, https]
  register: r_fw
  failed_when: false
  changed_when: "'success' in (r_fw.stdout | lower)"

- name: Reload firewalld (best effort)
  command: firewall-cmd --reload
  register: r_fw_reload
  failed_when: false
  changed_when: "'success' in (r_fw_reload.stdout | lower)"

- name: Ensure httpd enabled and started (best effort)
  systemd:
    name: httpd
    enabled: true
    state: started
  failed_when: false

# ------------------------------------------------------------
# 2) TLS cert (self-signed if missing)
# ------------------------------------------------------------
- name: Check cert/key exist
  stat:
    path: "{{ item }}"
  loop:
    - "{{ waf_cert }}"
    - "{{ waf_key }}"
  register: r_tls

- name: Generate self-signed cert if missing (best effort)
  command: >
    openssl req -x509 -newkey rsa:2048 -nodes
    -keyout {{ waf_key }}
    -out {{ waf_cert }}
    -days 365
    -subj "/CN={{ waf_servername }}"
  when:
    - not ansible_check_mode
    - (r_tls.results[0].stat.exists == false) or (r_tls.results[1].stat.exists == false)
  failed_when: false

# ------------------------------------------------------------
# 3) CRS install / rules-enabled 구성
# ------------------------------------------------------------
- name: Ensure ModSecurity base dir exists
  file:
    path: /etc/httpd/modsecurity.d
    state: directory
    mode: "0755"

# 과거 수동 디버깅 파일/중복 include 파일들 제거(재배포 안정화)
- name: Remove old include leftovers that cause duplicate IDs (safe)
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/etc/httpd/modsecurity.d/crs-setup.conf"          # (X) 과거 위치
    - "/etc/httpd/modsecurity.d/owasp-crs.conf"          # (X) 과거 위치
    - "/etc/httpd/modsecurity.d/owasp-crs.conf.bak"
    - "/etc/httpd/conf.d/modsecurity-crs.conf"           # (X) activated_rules include 임시파일
    - "/etc/httpd/conf.d/zzz-modsec-audit.conf"          # (X) 수동 디버깅
    - "/etc/httpd/conf.d/zzz-modsec-global.conf"         # (X) 수동 디버깅
    - "/etc/httpd/conf.d/zzz-modsec-*.conf"              # (X) 혹시 남아있으면 전부 제거
  ignore_errors: true

- name: Clone OWASP CRS if not exists (skip in offline mode)
  git:
    repo: "https://github.com/coreruleset/coreruleset.git"
    dest: "{{ crs_dir }}"
    version: "v4.12.0"
    update: false
  when:
    - not ansible_check_mode
    - not (waf_offline | bool)
  failed_when: false

- name: Ensure CRS setup conf present (skip in offline mode)
  copy:
    remote_src: true
    src: "{{ crs_dir }}/crs-setup.conf.example"
    dest: "{{ crs_dir }}/crs-setup.conf"
    owner: root
    group: root
    mode: "0644"
  when:
    - not ansible_check_mode
    - not (waf_offline | bool)
  failed_when: false

- name: Ensure rules-enabled directory exists
  file:
    path: "{{ crs_rules_enabled }}"
    state: directory
    mode: "0755"

- name: Link CRS .conf into rules-enabled (best effort)
  command: bash -lc 'test -d {{ crs_dir }}/rules && ln -sf {{ crs_dir }}/rules/*.conf {{ crs_rules_enabled }}/ || true'
  changed_when: false

- name: Link CRS .data into rules-enabled (best effort)
  command: bash -lc 'test -d {{ crs_dir }}/rules && ls {{ crs_dir }}/rules/*.data >/dev/null 2>&1 && ln -sf {{ crs_dir }}/rules/*.data {{ crs_rules_enabled }}/ || true'
  changed_when: false

# ------------------------------------------------------------
# 4) Apache conf deploy
# ------------------------------------------------------------
- name: Deploy security headers include
  copy:
    src: security-headers.conf
    dest: /etc/httpd/conf.d/security-headers.conf
    owner: root
    group: root
    mode: "0644"

- name: Deploy SSL WAF vhost (reverse proxy to backend)
  copy:
    src: ssl-waf.conf
    dest: /etc/httpd/conf.d/ssl-waf.conf
    owner: root
    group: root
    mode: "0644"

# ------------------------------------------------------------
# 5) 핵심: ModSecurity custom conf는 템플릿으로 단일화 (Single Source of Truth)
#    - CRS include도 여기서만 수행
#    - audit 옵션도 여기서만 제어
# ------------------------------------------------------------
- name: Deploy modsecurity custom include (single source of truth)
  template:
    src: mod_security_custom.conf.j2
    dest: /etc/httpd/conf.d/mod_security_custom.conf
    owner: root
    group: root
    mode: "0644"

# ------------------------------------------------------------
# 6) 기본 mod_security.conf의 activated_rules include 비활성 (중복 RuleID 방지)
# ------------------------------------------------------------
- name: Check default mod_security.conf exists
  stat:
    path: /etc/httpd/conf.d/mod_security.conf
  register: r_modsec_default

- name: Disable default activated_rules include if present
  replace:
    path: /etc/httpd/conf.d/mod_security.conf
    regexp: '^\s*IncludeOptional\s+modsecurity\.d/activated_rules/\*\.conf\s*$'
    replace: '# IncludeOptional modsecurity.d/activated_rules/*.conf'
  when: r_modsec_default.stat.exists
  failed_when: false

# ------------------------------------------------------------
# 7) 발표용 403 보장 룰 (옵션)
# ------------------------------------------------------------
- name: Deploy demo blocking rule (optional)
  template:
    src: zz-test-rule.conf.j2
    dest: /etc/httpd/conf.d/zz-test-rule.conf
    owner: root
    group: root
    mode: "0644"
  when: waf_demo_block_enable | bool

- name: Remove demo blocking rule when disabled
  file:
    path: /etc/httpd/conf.d/zz-test-rule.conf
    state: absent
  when: not (waf_demo_block_enable | bool)

# ------------------------------------------------------------
# 8) Validate + restart
# ------------------------------------------------------------
- name: Validate Apache config (best effort)
  command: apachectl configtest
  register: r_cfg
  changed_when: false
  failed_when: false

- name: Restart httpd (best effort)
  systemd:
    name: httpd
    state: restarted
  failed_when: false

