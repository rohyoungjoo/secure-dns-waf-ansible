---
# roles/secure/tasks/main.yml
# PC1-SECURE: firewalld 기반 NAT/포트포워딩 + sysctl(rp_filter=2) 한방 정리

- name: Set variables (single-file defaults)
  set_fact:
    secure_public_if: "ens160"
    secure_trusted_if: "ens192"
    secure_trusted_src: "10.2.2.0/24"
    secure_rp_filter: 2

    # forward-ports 목록 (여기서는 YAML이라 주석 OK)
    secure_forward_ports:
      - { port: 80,    toport: 80,    toaddr: "10.2.1.2" }
      - { port: 443,   toport: 443,   toaddr: "10.2.1.2" }

      - { port: 8080,  toport: 8080,  toaddr: "10.2.2.40" }   # Jenkins
      - { port: 3001,  toport: 3001,  toaddr: "10.2.2.40" }   # Gitea
      - { port: 5000,  toport: 5000,  toaddr: "10.2.2.40" }   # Harbor/Registry

      - { port: 3000,  toport: 3000,  toaddr: "10.2.2.50" }   # Grafana
      - { port: 9090,  toport: 9090,  toaddr: "10.2.2.50" }   # Prometheus
      - { port: 9093,  toport: 9093,  toaddr: "10.2.2.50" }   # Alertmanager

      # (기존 NodePort) - 팀 환경에 맞게 유지/수정
      - { port: 30080, toport: 30080, toaddr: "10.2.2.8" }
      - { port: 30090, toport: 30090, toaddr: "10.2.2.8" }

      # (임시) ArgoCD NodePort
      - { port: 31372, toport: 31372, toaddr: "10.2.2.2" }

- name: Install required packages (firewalld, iproute)
  command: dnf -y install firewalld iproute
  register: r_dnf
  changed_when: "'Complete!' in (r_dnf.stdout | default(''))"
  failed_when: false

- name: Enable and start firewalld
  command: systemctl enable --now firewalld

- name: Persist sysctl settings for forwarding and rp_filter
  copy:
    dest: /etc/sysctl.d/99-pc1-secure.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.default.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.{{ secure_public_if }}.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.{{ secure_trusted_if }}.rp_filter = {{ secure_rp_filter }}

- name: Apply sysctl settings now
  command: sysctl --system

- name: Ensure public interface in public zone (permanent)
  command: firewall-cmd --permanent --zone=public --add-interface={{ secure_public_if }}
  register: r_pub_if
  failed_when: false
  changed_when: "'success' in (r_pub_if.stdout | lower)"

- name: Ensure trusted interface in trusted zone (permanent)
  command: firewall-cmd --permanent --zone=trusted --add-interface={{ secure_trusted_if }}
  register: r_tru_if
  failed_when: false
  changed_when: "'success' in (r_tru_if.stdout | lower)"

- name: Ensure trusted zone allows source (permanent)
  command: firewall-cmd --permanent --zone=trusted --add-source={{ secure_trusted_src }}
  register: r_tru_src
  failed_when: false
  changed_when: "'success' in (r_tru_src.stdout | lower)"

- name: Enable masquerade on public zone (permanent)
  command: firewall-cmd --permanent --zone=public --add-masquerade
  register: r_masq
  failed_when: false
  changed_when: "'success' in (r_masq.stdout | lower)"

- name: Open HTTP/HTTPS on public zone (permanent)
  command: firewall-cmd --permanent --zone=public --add-service=http --add-service=https
  register: r_open_web
  failed_when: false
  changed_when: "'success' in (r_open_web.stdout | lower)"

- name: Remove wide NodePort forward range (30000-32767) to cp1 (permanent) - if exists
  command: firewall-cmd --permanent --zone=public --remove-forward-port=port=30000-32767:proto=tcp:toaddr=10.2.2.2
  register: r_rm_np_range
  failed_when: false
  changed_when: "'success' in (r_rm_np_range.stdout | lower)"

- name: Add forward-ports (permanent)
  command: >
    firewall-cmd --permanent --zone=public
    --add-forward-port=port={{ item.port }}:proto=tcp:toport={{ item.toport }}:toaddr={{ item.toaddr }}
  loop: "{{ secure_forward_ports }}"
  register: r_fwd_ports
  failed_when: false
  changed_when: "'success' in (r_fwd_ports.stdout | lower)"

- name: Reload firewalld to apply permanent rules
  command: firewall-cmd --reload

